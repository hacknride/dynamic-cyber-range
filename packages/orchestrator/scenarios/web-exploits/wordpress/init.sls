{% set wp = pillar.get('wordpress', {}) %}
{% set version = wp.get('version', '6.4') %}
{% set install_dir = wp.get('install_dir', '/var/www/wordpress') %}
{% set web_user = wp.get('web_user', 'www-data') %}
{% set web_group = wp.get('web_group', 'www-data') %}
{% set db = wp.get('db', {}) %}
{% set db_name = db.get('name', 'wordpress') %}
{% set db_user = db.get('user', 'wp_user') %}
{% set db_pass = db.get('password', 'password') %}
{% set db_host = db.get('host', 'localhost') %}
{% set php_version = wp.get('php_version', '8.3') %}

# --- Packages ---------------------------------------------------------
wordpress_stack:
  pkg.installed:
    - pkgs:
      - nginx
      - php-fpm
      - php-mysql
      - mariadb-server
      - curl
      - tar
      - python3-pymysql   # needed for salt's mysql_* states

# --- Directory --------------------------------------------------------
{{ install_dir }}:
  file.directory:
    - user: {{ web_user }}
    - group: {{ web_group }}
    - mode: "0755"
    - makedirs: True
    - require:
      - pkg: wordpress_stack

# --- Download & extract WordPress (flattened) ------------------------
wp_archive:
  archive.extracted:
    - name: {{ install_dir }}
    - source: https://wordpress.org/wordpress-{{ version }}.tar.gz
    - archive_format: tar
    - options: --strip-components=1
    - if_missing: {{ install_dir }}/wp-settings.php
    - require:
      - file: {{ install_dir }}

# --- Database (MariaDB) -----------------------------------------------
# Uses unix_socket auth as root on Ubuntu/MariaDB
create_wp_db:
  mysql_database.present:
    - name: {{ db_name }}
    - require:
      - pkg: wordpress_stack
      - service: mariadb_service

create_wp_user:
  mysql_user.present:
    - name: {{ db_user }}
    - host: '%'
    - password: {{ db_pass }}
    - require:
      - mysql_database: create_wp_db

grant_wp_privs:
  mysql_grants.present:
    - name: "{{ db_user }} on {{ db_name }}.*"
    - grant: ALL PRIVILEGES
    - database: {{ db_name }}.*
    - user: {{ db_user }}
    - host: '%'
    - require:
      - mysql_user: create_wp_user

# --- wp-config.php (minimal, installer-ready) -------------------------
{{ install_dir }}/wp-config.php:
  file.managed:
    - contents: |
        <?php
        define('DB_NAME', '{{ db_name }}');
        define('DB_USER', '{{ db_user }}');
        define('DB_PASSWORD', '{{ db_pass }}');
        define('DB_HOST', '{{ db_host }}');
        define('WP_DEBUG', false);
        if ( !defined('ABSPATH') )
          define('ABSPATH', __DIR__ . '/');
        require_once ABSPATH . 'wp-settings.php';
        ?>
    - user: {{ web_user }}
    - group: {{ web_group }}
    - mode: '0640'
    - require:
      - archive: wp_archive
      - mysql_grants: grant_wp_privs

# --- Permissions (recursive chown) -----------------------------------
wp_perms:
  file.directory:
    - name: {{ install_dir }}
    - user: {{ web_user }}
    - group: {{ web_group }}
    - recurse:
      - user
      - group
    - require:
      - file: {{ install_dir }}/wp-config.php

# --- Nginx site -------------------------------------------------------
/etc/nginx/sites-available/wordpress:
  file.managed:
    - contents: |
        server {
          listen 80;
          server_name _;
          root {{ install_dir }};
          index index.php index.html;

          location / {
            try_files $uri $uri/ /index.php?$args;
          }

          location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/run/php/php{{ php_version }}-fpm.sock;
          }

          location ~* \.(log|conf)$ {
            deny all;
          }
        }
    - require:
      - pkg: wordpress_stack
      - file: {{ install_dir }}

/etc/nginx/sites-enabled/wordpress:
  file.symlink:
    - target: /etc/nginx/sites-available/wordpress
    - require:
      - file: /etc/nginx/sites-available/wordpress

remove_default_nginx_site:
  file.absent:
    - name: /etc/nginx/sites-enabled/default

# --- Services ---------------------------------------------------------
mariadb_service:
  service.running:
    - name: mariadb
    - enable: True
    - require:
      - pkg: wordpress_stack

php_fpm_service:
  service.running:
    - name: php{{ php_version }}-fpm
    - enable: True
    - require:
      - pkg: wordpress_stack

nginx_service:
  service.running:
    - name: nginx
    - enable: True
    - watch:
      - file: /etc/nginx/sites-available/wordpress
      - file: /etc/nginx/sites-enabled/wordpress
      - file: {{ install_dir }}
    - require:
      - service: php_fpm_service
