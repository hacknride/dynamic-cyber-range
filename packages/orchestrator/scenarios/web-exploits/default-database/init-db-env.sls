{# =========================
   Tunables
   ========================= #}
{% set db_name      = 'vulnapp' %}
{% set db_user      = 'root' %}
{% set db_pass      = 'root' %}      # intentionally weak
{% set backup_dir   = '/opt/db_backups' %}

{# =========================
   1. Packages
   ========================= #}

mariadb-server:
  pkg.installed:
    - name: mariadb-server

mariadb-client:
  pkg.installed:
    - name: mariadb-client

{# =========================
   2. Open MariaDB to 0.0.0.0
   ========================= #}

mariadb-config-open:
  file.replace:
    - name: /etc/mysql/mariadb.conf.d/50-server.cnf
    - pattern: '^bind-address\s*=.*'
    - repl: 'bind-address            = 0.0.0.0'
    - append_if_not_found: True
    - require:
      - pkg: mariadb-server

mariadb-service:
  service.running:
    - name: mariadb
    - enable: True
    - watch:
      - file: mariadb-config-open

{# =========================
   3. Create insecure DB + user
   ========================= #}

vuln_db_setup:
  cmd.run:
    - name: >
        mysql -uroot -e "
        CREATE DATABASE IF NOT EXISTS {{ db_name }};
        CREATE USER IF NOT EXISTS '{{ db_user }}'@'%' IDENTIFIED BY '{{ db_pass }}';
        GRANT ALL PRIVILEGES ON {{ db_name }}.* TO '{{ db_user }}'@'%';
        FLUSH PRIVILEGES;"
    - require:
      - service: mariadb-service
    - unless: >
        mysql -uroot -e
        "SELECT User,Host FROM mysql.user WHERE User='{{ db_user }}' AND Host='%';"
        | grep '{{ db_user }}'

{# =========================
   4. Seed DB with 3 users
   ========================= #}

vuln_db_seed:
  cmd.run:
    - name: >
        mysql -u{{ db_user }} -p{{ db_pass }} {{ db_name }} -e "
          CREATE TABLE IF NOT EXISTS users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            username VARCHAR(50),
            password VARCHAR(200),
            email VARCHAR(100)
          );
          INSERT INTO users (username, password, email) VALUES
            ('alice', 'password123', 'alice@example.com'),
            ('bob',   'super-secure-pass1!',   'bob@example.com'),
            ('admin', 'admin123!@#', 'admin@example.com');
        "
    - require:
      - cmd: vuln_db_setup
    - unless: >
        mysql -u{{ db_user }} -p{{ db_pass }} {{ db_name }} -e "SELECT * FROM users LIMIT 1;"

{# =========================
   5. World-readable DB dump
   ========================= #}

vuln_backup_dir:
  file.directory:
    - name: {{ backup_dir }}
    - user: root
    - group: root
    - mode: '0777'          # deliberately over-permissive

vuln_db_dump:
  cmd.run:
    - name: >
        mysqldump -uroot {{ db_name }} > {{ backup_dir }}/{{ db_name }}.sql
        && chmod 0644 {{ backup_dir }}/{{ db_name }}.sql
    - require:
      - cmd: vuln_db_seed
      - file: vuln_backup_dir
    - unless: test -f {{ backup_dir }}/{{ db_name }}.sql

